# 网关层权限校验功能实现总结

## 1. 实现概述

本项目实现了网关层的统一权限校验功能，通过基于角色的访问控制（RBAC）模型，确保不同角色的用户只能访问其被授权的资源。

## 2. 文件变更清单

### 2.1 新增文件
- `openspec/gateway-permission-spec.md` - 权限校验功能规格说明文档

### 2.2 修改文件

#### 2.2.1 网关层过滤器
- **文件**: `gateway/src/main/java/com/hutb/gateway/filter/GlobalFilter.java`
- **变更内容**:
  - 添加了基于角色的权限校验逻辑
  - 实现了四种角色的差异化权限控制
  - 更新了JWT解析逻辑以提取用户角色信息
  - 添加了HTTP 403状态码返回处理

#### 2.2.2 公共工具类
- **文件**: `common-utils/src/main/java/com/hutb/commonUtils/utils/JwtUtil.java`
- **变更内容**:
  - 添加了`createTokenWithRole`方法，用于生成包含角色信息的JWT令牌

#### 2.2.3 用户服务实现
- **文件**: `user-service/src/main/java/com/hutb/user/service/impl/UserServiceImpl.java`
- **变更内容**:
  - 更新登录方法，使用包含角色信息的JWT令牌生成方法
  - 将用户角色信息嵌入到JWT令牌中

### 2.2.4 网关JWT工具类
- **文件**: `gateway/src/main/java/com/hutb/gateway/utils/JwtUtil.java`
- **变更内容**:
  - 添加了`createTokenWithRole`方法，用于生成包含角色信息的JWT令牌





## 3. 权限控制规则

### 3.1 超管权限 (`super_admin`)
- 拥有所有操作权限
- 可访问所有微服务的所有接口

### 3.2 普通管理员权限 (`normal_admin`)
- 可管理自己的账户信息
- 可管理普通用户和志愿者的信息
- 可访问相关业务接口

### 3.3 普通用户权限 (`normal_user`)
- 仅可管理自己的信息
- 仅可查看志愿者服务内容（只读权限）
- 无法进行具体的业务操作

### 3.4 志愿者权限 (`volunteer`)
- 可参与志愿活动服务
- 可使用商品服务
- 在志愿者相关功能中具有完整的CRUD权限

## 4. 技术实现要点

### 4.1 JWT令牌结构
JWT令牌现在包含以下声明：
- `username`: 用户名
- `role`: 用户角色
- `timestamp`: 时间戳
- `exp`: 过期时间

### 4.2 网关过滤器工作流程
1. 检查请求路径是否为登录/注册接口（免检）
2. 提取请求中的JWT令牌
3. 验证令牌有效性
4. 解析用户角色信息
5. 根据角色和请求路径执行权限校验
6. 通过校验则转发请求，否则返回403错误

### 4.3 权限校验算法
权限校验采用白名单模式，仅允许预定义路径模式被访问：
- 超管可访问所有路径
- 普通管理员可访问用户和志愿者管理相关路径
- 普通用户仅可访问自我管理及志愿者内容查看路径
- 志愿者可访问志愿活动和商品服务路径

## 5. 测试验证点

### 5.1 功能测试
- 验证各角色用户访问权限是否符合预期
- 测试无权限访问时正确返回403错误
- 验证登录注册接口不受权限控制影响

### 5.2 边界测试
- 测试无效JWT令牌的处理
- 测试缺少角色信息的令牌处理
- 验证令牌过期情况下的行为

### 5.3 性能测试
- 验证权限校验对系统性能的影响
- 确保过滤器不会成为性能瓶颈

## 6. 安全考虑

- 所有权限校验都在网关层完成，防止绕过权限控制
- 敏感操作在目标微服务中也应进行二次权限校验
- 记录权限拒绝事件，便于安全审计
- JWT密钥应当安全存储，避免硬编码

## 7. 后续优化建议

- 可考虑引入外部权限管理系统，实现更灵活的权限配置
- 可添加更细粒度的权限控制，如基于资源ID的访问控制
- 可实现动态权限配置，支持运行时权限调整